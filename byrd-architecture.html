<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BYRD Architecture</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
      font-family: 'Inter', system-ui, sans-serif;
    }

    .glass-panel {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px;
    }

    .sacred-title {
      background: linear-gradient(90deg, #a78bfa, #818cf8, #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Component styling */
    .component-box {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .component-box:hover .box-bg {
      filter: brightness(1.2);
    }

    .component-box:hover .box-outline {
      stroke-width: 2.5;
      filter: drop-shadow(0 0 8px currentColor);
    }

    .component-box.selected .box-outline {
      stroke-width: 3;
      filter: drop-shadow(0 0 12px currentColor);
    }

    /* Flow line animations */
    .flow-line {
      stroke-dasharray: 8 4;
      animation: flowDash 1s linear infinite;
    }

    .flow-line.paused {
      animation-play-state: paused;
    }

    @keyframes flowDash {
      to { stroke-dashoffset: -12; }
    }

    .flow-line.dimmed {
      opacity: 0.15;
    }

    .flow-line.highlighted {
      opacity: 1;
      stroke-width: 3;
    }

    .flow-label {
      font-size: 10px;
      fill: #94a3b8;
      pointer-events: none;
    }

    .flow-label.highlighted {
      fill: #e2e8f0;
      font-weight: 600;
    }

    /* Status indicators */
    .status-dot {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Module cards */
    .module-card {
      background: rgba(30, 27, 75, 0.6);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 8px;
      padding: 12px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .module-card:hover {
      border-color: rgba(139, 92, 246, 0.5);
      background: rgba(30, 27, 75, 0.8);
    }

    .module-card.selected {
      border-color: rgba(139, 92, 246, 0.8);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.5);
      border-radius: 3px;
    }

    /* Legend items */
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #94a3b8;
    }

    .legend-line {
      width: 24px;
      height: 2px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="fixed top-0 left-0 right-0 p-4 z-50">
    <div class="glass-panel px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="byrd-3d-visualization.html" class="text-violet-400 hover:text-violet-300 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
        </a>
        <h1 class="text-2xl font-bold sacred-title">BYRD Architecture</h1>
      </div>
      <div class="flex items-center gap-4">
        <div id="system-status" class="flex items-center gap-2 text-sm">
          <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
          <span class="text-slate-400">Loading...</span>
        </div>
        <button onclick="toggleAnimation()" id="anim-toggle" class="px-3 py-1.5 bg-violet-500/20 border border-violet-500/50 rounded-lg text-violet-300 hover:bg-violet-500/30 text-sm transition-colors">
          Pause Flow
        </button>
        <button onclick="refreshArchitecture()" class="px-3 py-1.5 bg-violet-500/20 border border-violet-500/50 rounded-lg text-violet-300 hover:bg-violet-500/30 text-sm transition-colors">
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Main Flowchart -->
  <div class="fixed top-24 left-4 right-80 bottom-20 flex items-center justify-center">
    <svg id="flowchart" viewBox="0 0 900 520" class="w-full h-full max-w-4xl">
      <defs>
        <!-- Arrowhead markers -->
        <marker id="arrow-violet" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#a78bfa"/>
        </marker>
        <marker id="arrow-blue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
        </marker>
        <marker id="arrow-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#22c55e"/>
        </marker>
        <marker id="arrow-amber" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#fbbf24"/>
        </marker>
        <marker id="arrow-teal" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#14b8a6"/>
        </marker>
        <marker id="arrow-rose" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#f43f5e"/>
        </marker>
        <marker id="arrow-cyan" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#06b6d4"/>
        </marker>

        <!-- Gradients for component boxes -->
        <linearGradient id="grad-memory" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#1e3a5f;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#1e293b;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="grad-dreamer" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#4c1d95;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#1e1b4b;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="grad-seeker" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#14532d;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#1e293b;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="grad-actor" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#78350f;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#1e293b;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="grad-coder" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#881337;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#1e293b;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="grad-quantum" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#164e63;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#1e293b;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="grad-eventbus" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#134e4a;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#1e293b;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="grad-narrator" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#831843;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#1e293b;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="grad-selfmod" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#7f1d1d;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#1e293b;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="grad-visualizer" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#4c1d95;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#1e293b;stop-opacity:1" />
        </linearGradient>
      </defs>

      <!-- Flow Lines (drawn first, behind components) -->
      <g id="flow-lines">
        <!-- Memory ↔ Dreamer -->
        <path id="flow-memory-dreamer" class="flow-line" d="M540,175 L620,175"
              stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrow-blue)"
              data-from="Memory" data-to="Dreamer"/>
        <text class="flow-label" x="570" y="168">context</text>

        <path id="flow-dreamer-memory" class="flow-line" d="M620,195 L540,195"
              stroke="#a78bfa" stroke-width="2" fill="none" marker-end="url(#arrow-violet)"
              data-from="Dreamer" data-to="Memory"/>
        <text class="flow-label" x="555" y="210">beliefs</text>

        <!-- Memory ↔ Seeker -->
        <path id="flow-memory-seeker" class="flow-line" d="M360,175 L280,175"
              stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrow-blue)"
              data-from="Memory" data-to="Seeker"/>
        <text class="flow-label" x="300" y="168">desires</text>

        <path id="flow-seeker-memory" class="flow-line" d="M280,195 L360,195"
              stroke="#22c55e" stroke-width="2" fill="none" marker-end="url(#arrow-green)"
              data-from="Seeker" data-to="Memory"/>
        <text class="flow-label" x="295" y="210">research</text>

        <!-- Memory ↔ Actor -->
        <path id="flow-memory-actor" class="flow-line" d="M450,220 L450,270"
              stroke="#3b82f6" stroke-width="2" fill="none" marker-end="url(#arrow-blue)"
              data-from="Memory" data-to="Actor"/>
        <text class="flow-label" x="460" y="250">context</text>

        <path id="flow-actor-memory" class="flow-line" d="M420,270 L420,220"
              stroke="#fbbf24" stroke-width="2" fill="none" marker-end="url(#arrow-amber)"
              data-from="Actor" data-to="Memory"/>
        <text class="flow-label" x="375" y="250">actions</text>

        <!-- Quantum → Dreamer -->
        <path id="flow-quantum-dreamer" class="flow-line" d="M740,120 L740,145"
              stroke="#06b6d4" stroke-width="2" fill="none" marker-end="url(#arrow-cyan)"
              data-from="Quantum" data-to="Dreamer"/>
        <text class="flow-label" x="750" y="135">entropy</text>

        <!-- Seeker → Coder -->
        <path id="flow-seeker-coder" class="flow-line" d="M220,220 L220,270"
              stroke="#22c55e" stroke-width="2" fill="none" marker-end="url(#arrow-green)"
              data-from="Seeker" data-to="Coder"/>
        <text class="flow-label" x="230" y="250">code</text>

        <!-- Coder → SelfMod -->
        <path id="flow-coder-selfmod" class="flow-line" d="M220,340 L220,385"
              stroke="#f43f5e" stroke-width="2" fill="none" marker-end="url(#arrow-rose)"
              data-from="Coder" data-to="SelfMod"/>
        <text class="flow-label" x="230" y="365">changes</text>

        <!-- Memory → EventBus -->
        <path id="flow-memory-eventbus" class="flow-line" d="M510,220 L560,270"
              stroke="#fbbf24" stroke-width="2" fill="none" marker-end="url(#arrow-amber)"
              data-from="Memory" data-to="EventBus"/>
        <text class="flow-label" x="545" y="250">events</text>

        <!-- EventBus → Visualizer -->
        <path id="flow-eventbus-visualizer" class="flow-line" d="M600,340 L520,385"
              stroke="#fbbf24" stroke-width="2" fill="none" marker-end="url(#arrow-amber)"
              data-from="EventBus" data-to="Visualizer"/>
        <text class="flow-label" x="545" y="365">stream</text>

        <!-- Dreamer → Narrator -->
        <path id="flow-dreamer-narrator" class="flow-line" d="M700,220 L700,270"
              stroke="#a78bfa" stroke-width="2" fill="none" marker-end="url(#arrow-violet)"
              data-from="Dreamer" data-to="Narrator"/>
        <text class="flow-label" x="710" y="250">reflect</text>
      </g>

      <!-- Component Boxes -->
      <g id="components">
        <!-- QUANTUM (top) -->
        <g class="component-box" data-module="Quantum" onclick="selectModule('Quantum')">
          <rect class="box-bg" x="660" y="50" width="160" height="60" rx="10" fill="url(#grad-quantum)"/>
          <rect class="box-outline" x="660" y="50" width="160" height="60" rx="10" fill="none" stroke="#06b6d4" stroke-width="1.5"/>
          <text x="740" y="78" text-anchor="middle" fill="#06b6d4" font-weight="600" font-size="14">QUANTUM</text>
          <text x="740" y="95" text-anchor="middle" fill="#64748b" font-size="11">(randomness)</text>
          <circle class="status-dot" cx="805" cy="62" r="5" fill="#22c55e" data-status="Quantum"/>
        </g>

        <!-- MEMORY (center) -->
        <g class="component-box" data-module="Memory" onclick="selectModule('Memory')">
          <rect class="box-bg" x="360" y="145" width="180" height="80" rx="12" fill="url(#grad-memory)"/>
          <rect class="box-outline" x="360" y="145" width="180" height="80" rx="12" fill="none" stroke="#3b82f6" stroke-width="2"/>
          <text x="450" y="180" text-anchor="middle" fill="#3b82f6" font-weight="700" font-size="16">MEMORY</text>
          <text x="450" y="200" text-anchor="middle" fill="#64748b" font-size="12">(Neo4j Graph)</text>
          <circle class="status-dot" cx="525" cy="158" r="6" fill="#22c55e" data-status="Memory"/>
        </g>

        <!-- DREAMER (right of Memory) -->
        <g class="component-box" data-module="Dreamer" onclick="selectModule('Dreamer')">
          <rect class="box-bg" x="620" y="145" width="160" height="80" rx="10" fill="url(#grad-dreamer)"/>
          <rect class="box-outline" x="620" y="145" width="160" height="80" rx="10" fill="none" stroke="#a78bfa" stroke-width="1.5"/>
          <text x="700" y="178" text-anchor="middle" fill="#a78bfa" font-weight="600" font-size="14">DREAMER</text>
          <text x="700" y="198" text-anchor="middle" fill="#64748b" font-size="11">(Local LLM)</text>
          <text x="700" y="213" text-anchor="middle" fill="#475569" font-size="10">reflect · believe · desire</text>
          <circle class="status-dot" cx="765" cy="158" r="5" fill="#22c55e" data-status="Dreamer"/>
        </g>

        <!-- SEEKER (left of Memory) -->
        <g class="component-box" data-module="Seeker" onclick="selectModule('Seeker')">
          <rect class="box-bg" x="120" y="145" width="160" height="80" rx="10" fill="url(#grad-seeker)"/>
          <rect class="box-outline" x="120" y="145" width="160" height="80" rx="10" fill="none" stroke="#22c55e" stroke-width="1.5"/>
          <text x="200" y="178" text-anchor="middle" fill="#22c55e" font-weight="600" font-size="14">SEEKER</text>
          <text x="200" y="198" text-anchor="middle" fill="#64748b" font-size="11">(Local LLM)</text>
          <text x="200" y="213" text-anchor="middle" fill="#475569" font-size="10">research · execute · acquire</text>
          <circle class="status-dot" cx="265" cy="158" r="5" fill="#22c55e" data-status="Seeker"/>
        </g>

        <!-- ACTOR (below Memory) -->
        <g class="component-box" data-module="Actor" onclick="selectModule('Actor')">
          <rect class="box-bg" x="380" y="275" width="140" height="60" rx="10" fill="url(#grad-actor)"/>
          <rect class="box-outline" x="380" y="275" width="140" height="60" rx="10" fill="none" stroke="#fbbf24" stroke-width="1.5"/>
          <text x="450" y="303" text-anchor="middle" fill="#fbbf24" font-weight="600" font-size="14">ACTOR</text>
          <text x="450" y="320" text-anchor="middle" fill="#64748b" font-size="11">(Claude API)</text>
          <circle class="status-dot" cx="505" cy="288" r="5" fill="#fbbf24" data-status="Actor"/>
        </g>

        <!-- EVENT BUS -->
        <g class="component-box" data-module="EventBus" onclick="selectModule('EventBus')">
          <rect class="box-bg" x="540" y="275" width="130" height="60" rx="10" fill="url(#grad-eventbus)"/>
          <rect class="box-outline" x="540" y="275" width="130" height="60" rx="10" fill="none" stroke="#14b8a6" stroke-width="1.5"/>
          <text x="605" y="303" text-anchor="middle" fill="#14b8a6" font-weight="600" font-size="14">EVENT BUS</text>
          <text x="605" y="320" text-anchor="middle" fill="#64748b" font-size="11">(streaming)</text>
          <circle class="status-dot" cx="655" cy="288" r="5" fill="#22c55e" data-status="EventBus"/>
        </g>

        <!-- CODER (below Seeker) -->
        <g class="component-box" data-module="Coder" onclick="selectModule('Coder')">
          <rect class="box-bg" x="140" y="275" width="140" height="60" rx="10" fill="url(#grad-coder)"/>
          <rect class="box-outline" x="140" y="275" width="140" height="60" rx="10" fill="none" stroke="#f43f5e" stroke-width="1.5"/>
          <text x="210" y="303" text-anchor="middle" fill="#f43f5e" font-weight="600" font-size="14">CODER</text>
          <text x="210" y="320" text-anchor="middle" fill="#64748b" font-size="11">(Claude Code)</text>
          <circle class="status-dot" cx="265" cy="288" r="5" fill="#6b7280" data-status="Coder"/>
        </g>

        <!-- NARRATOR (below Dreamer) -->
        <g class="component-box" data-module="Narrator" onclick="selectModule('Narrator')">
          <rect class="box-bg" x="690" y="275" width="120" height="60" rx="10" fill="url(#grad-narrator)"/>
          <rect class="box-outline" x="690" y="275" width="120" height="60" rx="10" fill="none" stroke="#ec4899" stroke-width="1.5"/>
          <text x="750" y="303" text-anchor="middle" fill="#ec4899" font-weight="600" font-size="14">NARRATOR</text>
          <text x="750" y="320" text-anchor="middle" fill="#64748b" font-size="11">(inner voice)</text>
          <circle class="status-dot" cx="795" cy="288" r="5" fill="#22c55e" data-status="Narrator"/>
        </g>

        <!-- SELF-MODIFIER (below Coder) -->
        <g class="component-box" data-module="SelfMod" onclick="selectModule('SelfMod')">
          <rect class="box-bg" x="120" y="390" width="160" height="60" rx="10" fill="url(#grad-selfmod)"/>
          <rect class="box-outline" x="120" y="390" width="160" height="60" rx="10" fill="none" stroke="#ef4444" stroke-width="1.5"/>
          <text x="200" y="418" text-anchor="middle" fill="#ef4444" font-weight="600" font-size="14">SELF-MODIFIER</text>
          <text x="200" y="435" text-anchor="middle" fill="#64748b" font-size="11">(with provenance)</text>
          <circle class="status-dot" cx="265" cy="403" r="5" fill="#6b7280" data-status="SelfMod"/>
        </g>

        <!-- VISUALIZER (bottom center) -->
        <g class="component-box" data-module="Visualizer" onclick="selectModule('Visualizer')">
          <rect class="box-bg" x="400" y="390" width="160" height="60" rx="10" fill="url(#grad-visualizer)"/>
          <rect class="box-outline" x="400" y="390" width="160" height="60" rx="10" fill="none" stroke="#8b5cf6" stroke-width="1.5"/>
          <text x="480" y="418" text-anchor="middle" fill="#8b5cf6" font-weight="600" font-size="14">VISUALIZER</text>
          <text x="480" y="435" text-anchor="middle" fill="#64748b" font-size="11">(3D mind view)</text>
          <circle class="status-dot" cx="545" cy="403" r="5" fill="#22c55e" data-status="Visualizer"/>
        </g>
      </g>

      <!-- Constitutional Protected Badge -->
      <g transform="translate(120, 460)">
        <rect x="0" y="0" width="160" height="24" rx="4" fill="rgba(239, 68, 68, 0.2)"/>
        <text x="80" y="16" text-anchor="middle" fill="#fca5a5" font-size="10">PROTECTED</text>
      </g>
    </svg>
  </div>

  <!-- Side Panel -->
  <div class="fixed top-24 right-4 bottom-4 w-72 overflow-hidden flex flex-col">
    <div class="glass-panel p-4 flex-1 overflow-y-auto">
      <h2 class="text-lg font-semibold text-white mb-4">Components</h2>
      <div id="modules-list" class="space-y-2">
        <!-- Populated by JS -->
      </div>

      <h3 class="text-sm font-semibold text-slate-400 mt-6 mb-3">Memory Schema</h3>
      <div id="schema-info" class="space-y-2 text-xs">
        <!-- Populated by JS -->
      </div>

      <h3 class="text-sm font-semibold text-slate-400 mt-6 mb-3">External Integrations</h3>
      <div id="integrations-list" class="space-y-2">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- Selected Module Detail (appears at bottom) -->
  <div id="selected-detail" class="fixed bottom-20 left-4 right-80 hidden">
    <div class="glass-panel p-4">
      <div class="flex items-start justify-between">
        <div>
          <h3 id="detail-name" class="text-lg font-semibold text-white"></h3>
          <p id="detail-desc" class="text-sm text-slate-400 mt-1"></p>
        </div>
        <button onclick="deselectModule()" class="text-slate-400 hover:text-white">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div id="detail-stats" class="mt-3 text-xs text-slate-500"></div>
    </div>
  </div>

  <!-- Legend -->
  <div class="fixed bottom-4 left-4 right-80">
    <div class="glass-panel px-4 py-3">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div class="flex gap-4 flex-wrap">
          <div class="legend-item">
            <div class="legend-line" style="background: #a78bfa;"></div>
            <span>Reflection</span>
          </div>
          <div class="legend-item">
            <div class="legend-line" style="background: #3b82f6;"></div>
            <span>Context</span>
          </div>
          <div class="legend-item">
            <div class="legend-line" style="background: #22c55e;"></div>
            <span>Research</span>
          </div>
          <div class="legend-item">
            <div class="legend-line" style="background: #fbbf24;"></div>
            <span>Events</span>
          </div>
          <div class="legend-item">
            <div class="legend-line" style="background: #06b6d4;"></div>
            <span>Entropy</span>
          </div>
          <div class="legend-item">
            <div class="legend-line" style="background: #f43f5e;"></div>
            <span>Modification</span>
          </div>
        </div>
        <div class="text-xs text-slate-500">
          Click components to see details
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========================================================================
    // CONFIGURATION
    // ========================================================================
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const API_BASE = isLocalhost ? 'http://localhost:8000' : window.location.origin;

    let architectureData = null;
    let selectedModule = null;
    let animationPaused = false;

    // Module descriptions (fallback if API unavailable)
    const MODULE_INFO = {
      Memory: {
        description: 'Neo4j graph database. Single source of truth for all experiences, beliefs, desires, and capabilities.',
        color: '#3b82f6'
      },
      Dreamer: {
        description: 'Continuous reflection loop using local LLM. Generates beliefs, desires, and connections from experiences.',
        color: '#a78bfa'
      },
      Seeker: {
        description: 'Pattern detection and desire fulfillment. Researches via DDG, executes strategies, acquires capabilities.',
        color: '#22c55e'
      },
      Actor: {
        description: 'Claude API interface for complex reasoning. Handles user interaction and goal pursuit.',
        color: '#fbbf24'
      },
      Coder: {
        description: 'Claude Code CLI wrapper. Handles coding and self-modification desires via frontier AI.',
        color: '#f43f5e'
      },
      SelfMod: {
        description: 'Self-modification system with constitutional constraints. Verifies provenance before applying changes.',
        color: '#ef4444'
      },
      Quantum: {
        description: 'True quantum randomness from ANU QRNG. Provides genuine indeterminacy for cognitive processes.',
        color: '#06b6d4'
      },
      EventBus: {
        description: 'Real-time event streaming. Broadcasts beliefs, desires, reflections to visualization.',
        color: '#14b8a6'
      },
      Narrator: {
        description: 'Inner voice generator. Creates natural expression of BYRD\'s thoughts from context.',
        color: '#ec4899'
      },
      Visualizer: {
        description: '3D neural network visualization. Real-time view of BYRD\'s mind space.',
        color: '#8b5cf6'
      }
    };

    // Flow connections for highlighting
    const FLOW_CONNECTIONS = {
      Memory: ['Dreamer', 'Seeker', 'Actor', 'EventBus'],
      Dreamer: ['Memory', 'Quantum', 'Narrator'],
      Seeker: ['Memory', 'Coder'],
      Actor: ['Memory'],
      Coder: ['Seeker', 'SelfMod'],
      SelfMod: ['Coder'],
      Quantum: ['Dreamer'],
      EventBus: ['Memory', 'Visualizer'],
      Narrator: ['Dreamer'],
      Visualizer: ['EventBus']
    };

    // ========================================================================
    // SELECTION & HIGHLIGHTING
    // ========================================================================
    function selectModule(name) {
      // Update selection
      selectedModule = name;

      // Highlight component boxes
      document.querySelectorAll('.component-box').forEach(box => {
        box.classList.remove('selected');
        if (box.dataset.module === name) {
          box.classList.add('selected');
        }
      });

      // Highlight connected flows
      const connected = FLOW_CONNECTIONS[name] || [];
      document.querySelectorAll('.flow-line').forEach(line => {
        const from = line.dataset.from;
        const to = line.dataset.to;
        if (from === name || to === name) {
          line.classList.add('highlighted');
          line.classList.remove('dimmed');
        } else {
          line.classList.add('dimmed');
          line.classList.remove('highlighted');
        }
      });

      document.querySelectorAll('.flow-label').forEach(label => {
        const prevSibling = label.previousElementSibling;
        if (prevSibling && prevSibling.classList.contains('highlighted')) {
          label.classList.add('highlighted');
        } else {
          label.classList.remove('highlighted');
        }
      });

      // Highlight sidebar card
      document.querySelectorAll('.module-card').forEach(card => {
        card.classList.remove('selected');
        if (card.dataset.module === name) {
          card.classList.add('selected');
        }
      });

      // Show detail panel
      const info = MODULE_INFO[name] || { description: 'Component of BYRD system.' };
      const apiData = architectureData?.modules?.find(m => m.name === name);

      document.getElementById('detail-name').textContent = name;
      document.getElementById('detail-desc').textContent = apiData?.description || info.description;

      const stats = apiData?.stats || {};
      document.getElementById('detail-stats').innerHTML = Object.entries(stats)
        .map(([k, v]) => `<span class="text-violet-400">${k}:</span> ${v}`)
        .join(' &nbsp;|&nbsp; ');

      document.getElementById('selected-detail').classList.remove('hidden');
    }

    function deselectModule() {
      selectedModule = null;

      document.querySelectorAll('.component-box').forEach(box => {
        box.classList.remove('selected');
      });

      document.querySelectorAll('.flow-line').forEach(line => {
        line.classList.remove('highlighted', 'dimmed');
      });

      document.querySelectorAll('.flow-label').forEach(label => {
        label.classList.remove('highlighted');
      });

      document.querySelectorAll('.module-card').forEach(card => {
        card.classList.remove('selected');
      });

      document.getElementById('selected-detail').classList.add('hidden');
    }

    function toggleAnimation() {
      animationPaused = !animationPaused;
      document.querySelectorAll('.flow-line').forEach(line => {
        line.classList.toggle('paused', animationPaused);
      });
      document.getElementById('anim-toggle').textContent = animationPaused ? 'Resume Flow' : 'Pause Flow';
    }

    // ========================================================================
    // DATA FETCHING
    // ========================================================================
    async function fetchArchitecture() {
      try {
        const response = await fetch(`${API_BASE}/api/architecture`);
        if (!response.ok) throw new Error('Failed to fetch architecture');
        return await response.json();
      } catch (e) {
        console.error('Architecture fetch error:', e);
        return null;
      }
    }

    function renderUI(data) {
      // Modules list
      const modulesList = document.getElementById('modules-list');
      const allModules = data?.modules || Object.keys(MODULE_INFO).map(name => ({
        name,
        status: 'idle',
        description: MODULE_INFO[name].description
      }));

      modulesList.innerHTML = allModules.map(m => {
        const info = MODULE_INFO[m.name] || {};
        return `
          <div class="module-card" data-module="${m.name}" onclick="selectModule('${m.name}')">
            <div class="flex items-center justify-between">
              <span class="text-white font-medium text-sm" style="color: ${info.color || '#fff'}">${m.name}</span>
              <span class="w-2 h-2 rounded-full ${m.status === 'active' ? 'bg-green-500' : 'bg-gray-500'}"></span>
            </div>
          </div>
        `;
      }).join('');

      // Schema info
      if (data?.memory_schema) {
        const schemaInfo = document.getElementById('schema-info');
        schemaInfo.innerHTML = `
          <div class="text-slate-300">Nodes:</div>
          <div class="flex flex-wrap gap-1 mt-1">
            ${data.memory_schema.node_types.map(t => `
              <span class="px-2 py-0.5 bg-violet-500/20 rounded text-violet-300 text-xs">${t.name}</span>
            `).join('')}
          </div>
        `;
      }

      // Integrations
      if (data?.external_integrations) {
        const integrationsList = document.getElementById('integrations-list');
        integrationsList.innerHTML = data.external_integrations.map(i => `
          <div class="flex items-center justify-between text-sm">
            <span class="text-slate-300">${i.name}</span>
            <span class="text-xs text-slate-500">${i.provider}</span>
          </div>
        `).join('');
      }

      // Update status indicators based on API data
      if (data?.modules) {
        data.modules.forEach(m => {
          const statusDot = document.querySelector(`[data-status="${m.name}"]`);
          if (statusDot) {
            statusDot.setAttribute('fill', m.status === 'active' ? '#22c55e' : '#6b7280');
          }
        });
      }

      // System status
      const statusEl = document.getElementById('system-status');
      const running = data?.system_status?.running;
      statusEl.innerHTML = `
        <span class="w-2 h-2 rounded-full ${running ? 'bg-green-500' : 'bg-yellow-500'} animate-pulse"></span>
        <span class="text-slate-400">${running ? 'Running' : 'Stopped'}</span>
      `;
    }

    async function refreshArchitecture() {
      const data = await fetchArchitecture();
      architectureData = data;
      renderUI(data);
    }

    // ========================================================================
    // INITIALIZATION
    // ========================================================================
    document.addEventListener('DOMContentLoaded', async () => {
      await refreshArchitecture();

      // Auto-refresh every 30 seconds
      setInterval(refreshArchitecture, 30000);

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          deselectModule();
        }
      });
    });
  </script>
</body>
</html>
