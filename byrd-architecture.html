<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BYRD Architecture</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
      font-family: 'Inter', system-ui, sans-serif;
    }

    #canvas-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    .ui-overlay {
      position: fixed;
      z-index: 100;
      pointer-events: none;
    }

    .ui-overlay > * {
      pointer-events: auto;
    }

    .glass-panel {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px;
    }

    .module-card {
      background: rgba(30, 27, 75, 0.6);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 8px;
      padding: 12px;
      transition: all 0.3s ease;
    }

    .module-card:hover {
      border-color: rgba(139, 92, 246, 0.5);
      background: rgba(30, 27, 75, 0.8);
    }

    .module-card.active {
      border-color: rgba(34, 197, 94, 0.5);
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-active { background: #22c55e; }
    .status-idle { background: #fbbf24; }
    .status-disabled { background: #6b7280; }
    .status-connected { background: #3b82f6; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .data-flow-legend {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .flow-type {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #94a3b8;
    }

    .flow-line {
      width: 20px;
      height: 2px;
    }

    .sacred-title {
      background: linear-gradient(90deg, #a78bfa, #818cf8, #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.5);
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div id="canvas-container"></div>

  <!-- Header -->
  <div class="ui-overlay top-0 left-0 right-0 p-4">
    <div class="glass-panel px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="byrd-3d-visualization.html" class="text-violet-400 hover:text-violet-300 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
        </a>
        <h1 class="text-2xl font-bold sacred-title">BYRD Architecture</h1>
      </div>
      <div class="flex items-center gap-4">
        <div id="system-status" class="flex items-center gap-2 text-sm">
          <span class="status-dot status-idle"></span>
          <span class="text-slate-400">Loading...</span>
        </div>
        <button onclick="refreshArchitecture()" class="px-3 py-1.5 bg-violet-500/20 border border-violet-500/50 rounded-lg text-violet-300 hover:bg-violet-500/30 text-sm transition-colors">
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Module Details Panel (Right) -->
  <div class="ui-overlay top-24 right-4 bottom-4 w-80 overflow-hidden flex flex-col">
    <div class="glass-panel p-4 flex-1 overflow-y-auto">
      <h2 class="text-lg font-semibold text-white mb-4">Modules</h2>
      <div id="modules-list" class="space-y-3">
        <!-- Populated by JS -->
      </div>

      <h3 class="text-sm font-semibold text-slate-400 mt-6 mb-3">Memory Schema</h3>
      <div id="schema-info" class="space-y-2 text-xs">
        <!-- Populated by JS -->
      </div>

      <h3 class="text-sm font-semibold text-slate-400 mt-6 mb-3">External Integrations</h3>
      <div id="integrations-list" class="space-y-2">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- Data Flow Legend (Bottom) -->
  <div class="ui-overlay bottom-4 left-4 right-96">
    <div class="glass-panel px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="data-flow-legend">
          <div class="flow-type">
            <div class="flow-line" style="background: #a78bfa;"></div>
            <span>Reflection</span>
          </div>
          <div class="flow-type">
            <div class="flow-line" style="background: #3b82f6;"></div>
            <span>Context/Query</span>
          </div>
          <div class="flow-type">
            <div class="flow-line" style="background: #22c55e;"></div>
            <span>Research</span>
          </div>
          <div class="flow-type">
            <div class="flow-line" style="background: #fbbf24;"></div>
            <span>Events</span>
          </div>
          <div class="flow-type">
            <div class="flow-line" style="background: #ec4899;"></div>
            <span>Identity</span>
          </div>
          <div class="flow-type">
            <div class="flow-line" style="background: #14b8a6;"></div>
            <span>Randomness</span>
          </div>
        </div>
        <div class="text-xs text-slate-500">
          Click modules to highlight connections
        </div>
      </div>
    </div>
  </div>

  <!-- Selected Module Info (Bottom Left) -->
  <div id="selected-module" class="ui-overlay bottom-20 left-4 hidden">
    <div class="glass-panel p-4 max-w-md">
      <h3 id="selected-name" class="text-lg font-semibold text-white"></h3>
      <p id="selected-desc" class="text-sm text-slate-400 mt-1"></p>
      <div id="selected-stats" class="mt-3 text-xs text-slate-500"></div>
    </div>
  </div>

  <script>
    // ==========================================================================
    // CONFIGURATION
    // ==========================================================================
    const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const API_BASE = isLocalhost ? 'http://localhost:8000' : window.location.origin;

    // Module visual configuration
    const MODULE_CONFIG = {
      Memory: { color: 0x3b82f6, position: [0, 0, 0], size: 2.5, orbit: 0 },
      Ego: { color: 0xec4899, position: [0, 3, 0], size: 1.2, orbit: 1 },
      Dreamer: { color: 0xa78bfa, position: [4, 0, 0], size: 1.5, orbit: 2 },
      Seeker: { color: 0x22c55e, position: [-4, 0, 0], size: 1.5, orbit: 2 },
      Actor: { color: 0xfbbf24, position: [0, 0, 4], size: 1.3, orbit: 2 },
      Coder: { color: 0xf43f5e, position: [0, 0, -4], size: 1.0, orbit: 2 },
      EventBus: { color: 0x14b8a6, position: [3, 2, 3], size: 1.0, orbit: 3 },
      Quantum: { color: 0x06b6d4, position: [-3, 2, -3], size: 0.8, orbit: 3 },
      Visualizer: { color: 0x8b5cf6, position: [5, 3, 0], size: 0.7, orbit: 4 },
    };

    const FLOW_COLORS = {
      reflection: 0xa78bfa,
      context: 0x3b82f6,
      query: 0x3b82f6,
      research: 0x22c55e,
      action: 0xfbbf24,
      event: 0xfbbf24,
      identity: 0xec4899,
      randomness: 0x14b8a6,
      modification: 0xf43f5e,
    };

    // ==========================================================================
    // THREE.JS SETUP
    // ==========================================================================
    let scene, camera, renderer, controls;
    let moduleNodes = {};
    let dataFlowLines = [];
    let selectedModule = null;
    let architectureData = null;
    let orbitAngles = {};

    function initScene() {
      const container = document.getElementById('canvas-container');

      // Scene
      scene = new THREE.Scene();

      // Camera
      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(8, 6, 8);
      camera.lookAt(0, 0, 0);

      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      container.appendChild(renderer.domElement);

      // Ambient light
      const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
      scene.add(ambientLight);

      // Point lights
      const pointLight1 = new THREE.PointLight(0xa78bfa, 1, 100);
      pointLight1.position.set(10, 10, 10);
      scene.add(pointLight1);

      const pointLight2 = new THREE.PointLight(0x3b82f6, 0.8, 100);
      pointLight2.position.set(-10, -10, 10);
      scene.add(pointLight2);

      // Create orbital rings
      createOrbitalRings();

      // Raycaster for click detection
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2();

      renderer.domElement.addEventListener('click', (event) => {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(Object.values(moduleNodes));

        if (intersects.length > 0) {
          selectModule(intersects[0].object.userData.name);
        } else {
          deselectModule();
        }
      });

      // Mouse controls
      let isDragging = false;
      let previousMousePosition = { x: 0, y: 0 };
      let cameraRadius = 12;
      let cameraTheta = Math.PI / 4;
      let cameraPhi = Math.PI / 4;

      renderer.domElement.addEventListener('mousedown', () => isDragging = true);
      renderer.domElement.addEventListener('mouseup', () => isDragging = false);
      renderer.domElement.addEventListener('mouseleave', () => isDragging = false);

      renderer.domElement.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const deltaX = e.clientX - previousMousePosition.x;
        const deltaY = e.clientY - previousMousePosition.y;
        cameraTheta -= deltaX * 0.01;
        cameraPhi = Math.max(0.1, Math.min(Math.PI - 0.1, cameraPhi - deltaY * 0.01));
        updateCameraPosition();
        previousMousePosition = { x: e.clientX, y: e.clientY };
      });

      renderer.domElement.addEventListener('mousedown', (e) => {
        previousMousePosition = { x: e.clientX, y: e.clientY };
      });

      renderer.domElement.addEventListener('wheel', (e) => {
        cameraRadius = Math.max(5, Math.min(30, cameraRadius + e.deltaY * 0.01));
        updateCameraPosition();
      });

      function updateCameraPosition() {
        camera.position.x = cameraRadius * Math.sin(cameraPhi) * Math.cos(cameraTheta);
        camera.position.y = cameraRadius * Math.cos(cameraPhi);
        camera.position.z = cameraRadius * Math.sin(cameraPhi) * Math.sin(cameraTheta);
        camera.lookAt(0, 0, 0);
      }

      updateCameraPosition();

      // Handle resize
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      animate();
    }

    function createOrbitalRings() {
      const ringMaterial = new THREE.LineBasicMaterial({
        color: 0x4c1d95,
        transparent: true,
        opacity: 0.3
      });

      [4, 6, 8].forEach(radius => {
        const ringGeometry = new THREE.BufferGeometry();
        const points = [];
        for (let i = 0; i <= 64; i++) {
          const angle = (i / 64) * Math.PI * 2;
          points.push(new THREE.Vector3(
            Math.cos(angle) * radius,
            0,
            Math.sin(angle) * radius
          ));
        }
        ringGeometry.setFromPoints(points);
        const ring = new THREE.Line(ringGeometry, ringMaterial);
        scene.add(ring);
      });
    }

    function createModuleNode(name, config, data) {
      const geometry = name === 'Memory'
        ? new THREE.IcosahedronGeometry(config.size, 1)
        : new THREE.OctahedronGeometry(config.size, 0);

      const material = new THREE.MeshPhongMaterial({
        color: config.color,
        emissive: config.color,
        emissiveIntensity: 0.3,
        transparent: true,
        opacity: 0.9,
        shininess: 100
      });

      const mesh = new THREE.Mesh(geometry, material);

      // Position based on orbit
      const orbitRadius = config.orbit * 2.5;
      const angle = orbitAngles[name] || Math.random() * Math.PI * 2;
      orbitAngles[name] = angle;

      if (config.orbit === 0) {
        mesh.position.set(0, 0, 0);
      } else {
        mesh.position.set(
          Math.cos(angle) * orbitRadius,
          (config.orbit - 2) * 0.5,
          Math.sin(angle) * orbitRadius
        );
      }

      mesh.userData = { name, data, config };
      scene.add(mesh);
      moduleNodes[name] = mesh;

      // Add glow effect for active modules
      if (data && (data.status === 'active' || data.status === 'connected')) {
        const glowGeometry = new THREE.SphereGeometry(config.size * 1.3, 16, 16);
        const glowMaterial = new THREE.MeshBasicMaterial({
          color: config.color,
          transparent: true,
          opacity: 0.15
        });
        const glow = new THREE.Mesh(glowGeometry, glowMaterial);
        mesh.add(glow);
      }

      return mesh;
    }

    function createDataFlowLine(source, target, flowType) {
      const sourceNode = moduleNodes[source];
      const targetNode = moduleNodes[target];

      if (!sourceNode || !targetNode) return null;

      const points = [];
      const start = sourceNode.position.clone();
      const end = targetNode.position.clone();

      // Create curved path
      const mid = start.clone().add(end).multiplyScalar(0.5);
      mid.y += 1;

      const curve = new THREE.QuadraticBezierCurve3(start, mid, end);
      const curvePoints = curve.getPoints(20);

      const geometry = new THREE.BufferGeometry().setFromPoints(curvePoints);
      const material = new THREE.LineBasicMaterial({
        color: FLOW_COLORS[flowType] || 0x666666,
        transparent: true,
        opacity: 0.4
      });

      const line = new THREE.Line(geometry, material);
      line.userData = { source, target, flowType };
      scene.add(line);
      dataFlowLines.push(line);

      return line;
    }

    function selectModule(name) {
      selectedModule = name;

      // Update visuals
      Object.entries(moduleNodes).forEach(([nodeName, mesh]) => {
        if (nodeName === name) {
          mesh.material.emissiveIntensity = 0.8;
          mesh.scale.setScalar(1.2);
        } else {
          mesh.material.emissiveIntensity = 0.1;
          mesh.scale.setScalar(1);
        }
      });

      // Highlight connected flows
      dataFlowLines.forEach(line => {
        if (line.userData.source === name || line.userData.target === name) {
          line.material.opacity = 0.9;
        } else {
          line.material.opacity = 0.1;
        }
      });

      // Show info panel
      const moduleData = architectureData?.modules?.find(m => m.name === name);
      if (moduleData) {
        document.getElementById('selected-module').classList.remove('hidden');
        document.getElementById('selected-name').textContent = moduleData.name;
        document.getElementById('selected-desc').textContent = moduleData.description;
        document.getElementById('selected-stats').innerHTML = Object.entries(moduleData.stats || {})
          .map(([k, v]) => `<span class="text-violet-400">${k}:</span> ${v}`)
          .join(' | ');
      }

      // Highlight in sidebar
      document.querySelectorAll('.module-card').forEach(card => {
        card.classList.toggle('ring-2', card.dataset.module === name);
        card.classList.toggle('ring-violet-500', card.dataset.module === name);
      });
    }

    function deselectModule() {
      selectedModule = null;

      Object.values(moduleNodes).forEach(mesh => {
        mesh.material.emissiveIntensity = 0.3;
        mesh.scale.setScalar(1);
      });

      dataFlowLines.forEach(line => {
        line.material.opacity = 0.4;
      });

      document.getElementById('selected-module').classList.add('hidden');
      document.querySelectorAll('.module-card').forEach(card => {
        card.classList.remove('ring-2', 'ring-violet-500');
      });
    }

    function animate() {
      requestAnimationFrame(animate);

      // Rotate modules slowly
      Object.entries(moduleNodes).forEach(([name, mesh]) => {
        mesh.rotation.y += 0.005;
        mesh.rotation.x += 0.002;

        // Orbit animation for non-center nodes
        const config = MODULE_CONFIG[name];
        if (config && config.orbit > 0) {
          orbitAngles[name] = (orbitAngles[name] || 0) + 0.001 * (4 - config.orbit);
          const radius = config.orbit * 2.5;
          mesh.position.x = Math.cos(orbitAngles[name]) * radius;
          mesh.position.z = Math.sin(orbitAngles[name]) * radius;
        }
      });

      // Update flow lines to follow moving nodes
      dataFlowLines.forEach(line => {
        const source = moduleNodes[line.userData.source];
        const target = moduleNodes[line.userData.target];
        if (source && target) {
          const start = source.position.clone();
          const end = target.position.clone();
          const mid = start.clone().add(end).multiplyScalar(0.5);
          mid.y += 1;
          const curve = new THREE.QuadraticBezierCurve3(start, mid, end);
          const points = curve.getPoints(20);
          line.geometry.setFromPoints(points);
        }
      });

      renderer.render(scene, camera);
    }

    // ==========================================================================
    // DATA FETCHING & UI
    // ==========================================================================
    async function fetchArchitecture() {
      try {
        const response = await fetch(`${API_BASE}/api/architecture`);
        if (!response.ok) throw new Error('Failed to fetch architecture');
        return await response.json();
      } catch (e) {
        console.error('Architecture fetch error:', e);
        return null;
      }
    }

    function renderModules(data) {
      // Clear existing
      Object.values(moduleNodes).forEach(node => scene.remove(node));
      dataFlowLines.forEach(line => scene.remove(line));
      moduleNodes = {};
      dataFlowLines = [];

      // Create module nodes
      data.modules.forEach(module => {
        const config = MODULE_CONFIG[module.name] || {
          color: 0x666666,
          position: [Math.random() * 6 - 3, Math.random() * 4, Math.random() * 6 - 3],
          size: 1,
          orbit: 3
        };
        createModuleNode(module.name, config, module);
      });

      // Add Visualizer node (not in API but part of architecture)
      createModuleNode('Visualizer', MODULE_CONFIG.Visualizer, {
        name: 'Visualizer',
        status: 'active',
        description: 'Real-time 3D visualization of BYRD\'s mind'
      });

      // Create data flow lines
      data.data_flows.forEach(flow => {
        createDataFlowLine(flow.source, flow.target, flow.flow_type);
      });
    }

    function renderUI(data) {
      // Modules list
      const modulesList = document.getElementById('modules-list');
      modulesList.innerHTML = data.modules.map(m => `
        <div class="module-card ${m.status === 'active' ? 'active' : ''}"
             data-module="${m.name}"
             onclick="selectModule('${m.name}')">
          <div class="flex items-center justify-between">
            <span class="text-white font-medium">${m.name}</span>
            <span class="status-dot status-${m.status}"></span>
          </div>
          <p class="text-xs text-slate-400 mt-1 line-clamp-2">${m.description}</p>
          ${Object.keys(m.stats).length > 0 ? `
            <div class="text-xs text-slate-500 mt-2">
              ${Object.entries(m.stats).slice(0, 2).map(([k, v]) => `${k}: ${v}`).join(' | ')}
            </div>
          ` : ''}
        </div>
      `).join('');

      // Schema info
      const schemaInfo = document.getElementById('schema-info');
      schemaInfo.innerHTML = `
        <div class="text-slate-300">Node Types:</div>
        <div class="flex flex-wrap gap-1 mt-1">
          ${data.memory_schema.node_types.map(t => `
            <span class="px-2 py-0.5 bg-violet-500/20 rounded text-violet-300">${t.name}</span>
          `).join('')}
        </div>
        <div class="text-slate-300 mt-3">Relationships:</div>
        <div class="flex flex-wrap gap-1 mt-1">
          ${data.memory_schema.relationship_types.map(r => `
            <span class="px-2 py-0.5 bg-blue-500/20 rounded text-blue-300">${r}</span>
          `).join('')}
        </div>
      `;

      // Integrations
      const integrationsList = document.getElementById('integrations-list');
      integrationsList.innerHTML = data.external_integrations.map(i => `
        <div class="flex items-center justify-between text-sm">
          <span class="text-slate-300">${i.name}</span>
          <span class="text-xs text-slate-500">${i.provider}</span>
        </div>
      `).join('');

      // System status
      const statusEl = document.getElementById('system-status');
      const running = data.system_status?.running;
      statusEl.innerHTML = `
        <span class="status-dot ${running ? 'status-active' : 'status-idle'}"></span>
        <span class="text-slate-400">${running ? 'Running' : 'Stopped'}</span>
      `;
    }

    async function refreshArchitecture() {
      const data = await fetchArchitecture();
      if (data) {
        architectureData = data;
        renderModules(data);
        renderUI(data);
      }
    }

    // ==========================================================================
    // INITIALIZATION
    // ==========================================================================
    document.addEventListener('DOMContentLoaded', async () => {
      initScene();
      await refreshArchitecture();

      // Auto-refresh every 30 seconds
      setInterval(refreshArchitecture, 30000);
    });
  </script>
</body>
</html>
